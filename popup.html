<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Patient Mapper</title>
        <!-- Extension Local Libraries -->
        <script src="lib/tailwind.min.js"></script>
        <script src="lib/lz-string.min.js"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <style>
            body {
                font-family: "Plus Jakarta Sans", sans-serif;
                letter-spacing: -0.01em;
                font-size: 13px;
            }
            ::-webkit-scrollbar {
                width: 6px;
            }
            ::-webkit-scrollbar-track {
                background: #f8fafc;
            }
            ::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 10px;
            }
            .compact-row:hover .actions {
                opacity: 1;
            }
            .hidden {
                display: none;
            }

            #sidebar {
                transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .sidebar-collapsed {
                width: 64px !important;
            }
            .sidebar-collapsed .nav-text,
            .sidebar-collapsed .brand-text {
                display: none;
            }
            .sidebar-collapsed .nav-item {
                justify-content: center;
                padding-left: 0;
                padding-right: 0;
            }

            @keyframes pulse-text {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }
            .animate-pulse-text {
                animation: pulse-text 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }

            input:disabled,
            select:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                background-color: #f1f5f9;
            }

            .status-pill {
                padding: 2px 8px;
                border-radius: 9999px;
                font-size: 10px;
                font-weight: 700;
                text-transform: uppercase;
            }

            /* Floating Controls Logic */
            .sticky-controls {
                position: sticky;
                /* Offset by tab-nav-wrapper height (40px) */
                top: 0;
                z-index: 30;
                background: #f8fafc; /* Match body bg to look seamless */
                padding-top: 8px;
                margin-top: -4px;
            }

            /* Smooth transition for the collapsible section */
            #advanced-options {
                max-height: 0;
                overflow: hidden;
                transition:
                    max-height 0.3s ease-out,
                    opacity 0.2s ease-out;
                opacity: 0;
                margin-bottom: 0;
            }
            #advanced-options.open {
                max-height: 500px;
                opacity: 1;
                margin-top: 1.25rem;
            }
            .rotate-180 {
                transform: rotate(180deg);
            }

            /* Custom scrollbar */
            .custom-scroll::-webkit-scrollbar {
                width: 4px;
            }
            .custom-scroll::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 10px;
            }
            .tag-input-container:focus-within {
                border-color: #3b82f6;
                background-color: white;
                box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
            }
            /* Highlight for the keyboard-selected item */
            .autocomplete-item-highlight {
                background-color: #eff6ff !important;
                border-left: 4px solid #3b82f6 !important;
            }
        </style>
    </head>
    <body class="bg-slate-50 flex h-screen overflow-hidden text-slate-900">
        <!-- Sidebar Navigation -->
        <aside
            id="sidebar"
            class="w-56 bg-white border-r border-slate-200 flex flex-col flex-shrink-0 relative"
        >
            <div
                class="p-4 flex items-center gap-3 border-b border-slate-50 relative"
            >
                <div
                    class="w-7 h-7 rounded bg-blue-600 flex items-center justify-center flex-shrink-0"
                >
                    <span class="text-white font-bold text-[10px]">PM</span>
                </div>
                <h1
                    class="text-sm font-bold text-slate-800 tracking-tight brand-text whitespace-nowrap"
                >
                    Patient Mapper
                </h1>

                <button
                    id="btn-toggle-sidebar"
                    class="absolute -right-3 top-5 w-6 h-6 bg-white border border-slate-200 rounded-full flex items-center justify-center hover:bg-slate-50 z-10 shadow-sm"
                >
                    <svg
                        id="toggle-icon"
                        class="w-3 h-3 text-slate-400 transition-transform duration-300"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 19l-7-7 7-7"
                        />
                    </svg>
                </button>
            </div>

            <nav class="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
                <button
                    id="sidebar-workspace"
                    class="nav-item w-full flex items-center px-3 py-2 text-xs font-semibold text-slate-500 hover:bg-slate-50 hover:text-slate-900 rounded-lg transition-all bg-blue-50 text-blue-600 font-bold"
                    title="Workspace"
                >
                    <svg
                        class="w-4 h-4 flex-shrink-0 mr-3"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                        />
                    </svg>
                    <span class="nav-text whitespace-nowrap">Workspace</span>
                </button>
                <button
                    id="sidebar-ids"
                    class="nav-item w-full flex items-center px-3 py-2 text-xs font-semibold text-slate-500 hover:bg-slate-50 hover:text-slate-900 rounded-lg transition-all"
                    title="ID Lists"
                >
                    <svg
                        class="w-4 h-4 flex-shrink-0 mr-3"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                        />
                    </svg>
                    <span class="nav-text whitespace-nowrap">ID Lists</span>
                </button>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
            <!-- Tab Bar System -->
            <div
                id="tab-container"
                class="bg-white border-b border-slate-200 flex items-center px-4 gap-1 h-10 flex-shrink-0 overflow-x-auto"
            >
                <button
                    id="tab-home"
                    class="px-4 h-full text-[11px] font-bold uppercase tracking-wider border-b-2 border-blue-600 text-blue-600 flex items-center gap-2"
                >
                    Home
                </button>
            </div>

            <div id="main-scroll-area" class="flex-1 overflow-y-auto">
                <!-- VIEW: ID Lists -->
                <div id="view-ids" class="p-6 space-y-6 mb-10 hidden">
                    <div
                        class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto"
                    >
                        <!-- Doctor IDs -->
                        <div>
                            <h3
                                class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 px-1"
                            >
                                Doctor Mapping (DPJP)
                            </h3>
                            <div
                                class="bg-white border border-slate-200 rounded-lg overflow-hidden shadow-sm"
                            >
                                <table class="w-full text-left border-collapse">
                                    <thead
                                        class="bg-slate-50 border-b border-slate-200 text-[10px] font-bold text-slate-500 uppercase"
                                    >
                                        <tr>
                                            <th class="px-4 py-2">Name</th>
                                            <th class="px-4 py-2">ID</th>
                                        </tr>
                                    </thead>
                                    <tbody
                                        id="doctor-table-body"
                                        class="divide-y divide-slate-100 text-[11px]"
                                    ></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Room IDs -->
                        <div>
                            <h3
                                class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 px-1"
                            >
                                Room Mapping
                            </h3>
                            <div
                                class="bg-white border border-slate-200 rounded-lg overflow-hidden shadow-sm"
                            >
                                <table class="w-full text-left border-collapse">
                                    <thead
                                        class="bg-slate-50 border-b border-slate-200 text-[10px] font-bold text-slate-500 uppercase"
                                    >
                                        <tr>
                                            <th class="px-4 py-2">Room</th>
                                            <th class="px-4 py-2">ID</th>
                                        </tr>
                                    </thead>
                                    <tbody
                                        id="room-table-body"
                                        class="divide-y divide-slate-100 text-[11px]"
                                    ></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: Home (Fetch Form) -->
                <div id="content-home" class="p-8 max-w-2xl mx-auto">
                    <div
                        class="bg-white border border-slate-200 rounded-2xl shadow-sm p-6"
                    >
                        <div class="mb-6 text-center">
                            <h2 class="text-lg font-bold text-slate-800">
                                Fetch Patients
                            </h2>
                            <p class="text-xs text-slate-400 font-medium">
                                Connect to
                                <a
                                    href="https://api.rsudsoediranms.com/apps/SIMpel/"
                                    class="font-medium text-fg-brand underline hover:no-underline"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    >RSUD Soediran API</a
                                >.
                            </p>
                        </div>
                        <form id="fetch-form" class="space-y-5">
                            <!-- Template Selection Section -->
                            <div class="relative space-y-2">
                                <label
                                    class="block text-[10px] font-bold text-slate-400 uppercase ml-1"
                                    >Quick Templates</label
                                >
                                <div class="relative">
                                    <button
                                        type="button"
                                        id="template-dropdown-btn"
                                        class="w-full flex items-center justify-between py-2 px-3 bg-slate-50 border border-slate-200 rounded-lg text-[11px] font-bold text-slate-700 hover:bg-slate-100 transition-all"
                                    >
                                        <span id="selected-template-label"
                                            >Select a template...</span
                                        >
                                        <svg
                                            class="w-3 h-3 text-slate-400"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M19 9l-7 7-7-7"
                                            ></path>
                                        </svg>
                                    </button>

                                    <div
                                        id="template-menu"
                                        class="hidden absolute z-30 w-full mt-1 bg-white border border-slate-200 rounded-xl shadow-2xl overflow-hidden"
                                    >
                                        <div
                                            class="p-2 border-b border-slate-100 bg-slate-50"
                                        >
                                            <input
                                                type="text"
                                                id="template-search"
                                                placeholder="Search templates..."
                                                class="w-full px-3 py-1.5 text-[11px] border border-slate-200 rounded-md outline-none focus:border-blue-500"
                                            />
                                        </div>
                                        <div
                                            id="template-list"
                                            class="max-height-[200px] overflow-y-auto max-h-48 py-1 custom-scroll"
                                        ></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tag-based Inputs -->
                            <div class="space-y-4">
                                <!-- Doctor ID Field -->
                                <div class="relative">
                                    <label
                                        class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5 ml-1"
                                        >Doctor (DPJP)</label
                                    >
                                    <div
                                        id="doc-tag-container"
                                        class="tag-input-container flex flex-wrap gap-1.5 min-h-[42px] p-2 bg-slate-50 border border-slate-200 rounded-xl transition-all cursor-text shadow-sm"
                                    >
                                        <!-- Tags injected here -->
                                        <input
                                            type="text"
                                            id="doc-input-field"
                                            autocomplete="off"
                                            placeholder="Search doctor or ';' for batch"
                                            class="flex-1 min-w-[80px] bg-transparent outline-none text-sm placeholder:text-slate-400"
                                        />
                                    </div>
                                    <!-- Autocomplete for Doctors -->
                                    <div
                                        id="doc-autocomplete"
                                        class="hidden absolute z-20 w-full mt-1 bg-white border border-slate-200 rounded-xl shadow-xl max-h-52 overflow-y-auto custom-scroll"
                                    ></div>
                                </div>

                                <!-- Room ID Field -->
                                <div class="relative">
                                    <label
                                        class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5 ml-1"
                                        >Room (RUANGAN)</label
                                    >
                                    <div
                                        id="room-tag-container"
                                        class="tag-input-container flex flex-wrap gap-1.5 min-h-[42px] p-2 bg-slate-50 border border-slate-200 rounded-xl transition-all cursor-text shadow-sm"
                                    >
                                        <input
                                            type="text"
                                            id="room-input-field"
                                            autocomplete="off"
                                            placeholder="Search room or ';' for batch"
                                            class="flex-1 min-w-[80px] bg-transparent outline-none text-sm placeholder:text-slate-400"
                                        />
                                    </div>
                                    <!-- Autocomplete for Rooms -->
                                    <div
                                        id="room-autocomplete"
                                        class="hidden absolute z-20 w-full mt-1 bg-white border border-slate-200 rounded-xl shadow-xl max-h-52 overflow-y-auto custom-scroll"
                                    ></div>
                                </div>
                            </div>

                            <!-- Collapsible Trigger -->
                            <button
                                type="button"
                                id="toggle-advanced-btn"
                                class="w-full flex items-center justify-center gap-2 py-2 px-4 bg-slate-50 hover:bg-slate-100 border border-dashed border-slate-200 rounded-lg text-[11px] font-bold text-blue-600 uppercase tracking-wider transition-all group"
                            >
                                <span>Advanced Options</span>
                                <svg
                                    id="chevron-icon"
                                    class="w-3 h-3 transition-transform duration-300"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="3"
                                        d="M19 9l-7 7-7-7"
                                    ></path>
                                </svg>
                            </button>

                            <!-- Collapsible Container -->
                            <div id="advanced-options" class="space-y-5">
                                <div
                                    class="bg-slate-50 p-4 rounded-xl border border-slate-100"
                                >
                                    <div
                                        class="flex items-center justify-between mb-2 px-1"
                                    >
                                        <label
                                            class="text-[10px] font-bold text-slate-500 uppercase"
                                            >Admission Date (MASUK)</label
                                        >
                                        <div class="flex items-center gap-2">
                                            <span
                                                class="text-[10px] font-semibold text-slate-400 uppercase"
                                                >Enable</span
                                            >
                                            <input
                                                type="checkbox"
                                                id="enable-date"
                                                class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                                            />
                                        </div>
                                    </div>
                                    <input
                                        type="date"
                                        id="form-date"
                                        disabled
                                        class="w-full px-3 py-2 bg-white border border-slate-200 rounded-xl outline-none focus:border-blue-500 transition-all"
                                    />
                                </div>
                                <div class="grid grid-cols-2 gap-4 mb-2">
                                    <div>
                                        <label
                                            class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5 ml-1"
                                            >Status</label
                                        >
                                        <select
                                            id="form-status"
                                            required
                                            class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500 focus:bg-white transition-all"
                                        >
                                            <option value="0">Inactive</option>
                                            <option value="1" selected>
                                                Active
                                            </option>
                                            <option value="2">
                                                Discharged
                                            </option>
                                        </select>
                                    </div>
                                    <div>
                                        <label
                                            class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5 ml-1"
                                            >Limit</label
                                        >
                                        <input
                                            type="number"
                                            id="form-limit"
                                            value="25"
                                            min="1"
                                            required
                                            class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500 focus:bg-white transition-all"
                                        />
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 pt-4">
                                <button
                                    type="reset"
                                    class="w-full bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 rounded-xl transition-all active:scale-[0.98]"
                                >
                                    Reset
                                </button>
                                <button
                                    type="submit"
                                    id="main-fetch-btn"
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-100 transition-all active:scale-[0.98]"
                                >
                                    Fetch
                                </button>
                            </div>
                        </form>
                        <div
                            id="auth-status"
                            class="mt-4 p-3 rounded-xl bg-slate-50 border border-slate-100 text-[11px] text-slate-500 hidden"
                        >
                            <div class="flex items-center gap-2">
                                <div
                                    class="w-2 h-2 rounded-full bg-slate-300 animate-pulse"
                                ></div>
                                <span id="auth-status-text"
                                    >Verifying session...</span
                                >
                            </div>
                        </div>
                    </div>
                </div>

                <div id="dynamic-content-area"></div>
            </div>
        </main>

        <script src="popup.js"></script>
    </body>
</html>
